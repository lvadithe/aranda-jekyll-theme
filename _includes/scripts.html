<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/modules/html2canvas.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/modules/jspdf.umd.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/main.js" type="module"></script>
<script src="{{ site.baseurl }}/assets/js/libs/iframeResizer.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/resize.js"></script>
<script src="{{ site.baseurl }}/assets/js/modules/handleCopyClick.js"></script>
<script>
    async function translateTextAndSave() {
        const subscriptionKey = "faf48684aab84958aa0ad9bea172126a";
        const endpoint = "https://api.cognitive.microsofttranslator.com/";
        const version = "3.0";

        const elementClass = "translatedContent";
        const selectedLanguage = document.getElementById("language").value;

        try {
            const elements = document.getElementsByClassName(elementClass);
            const translationPromises = [];

            for (const contentElement of elements) {
                const originalHTML = contentElement.innerHTML;
                const segments = originalHTML.split(
                    /(<script\b[^>]*>[^]*?<\/script>|<img\b[^>]*>)/g
                );

                const translatedSegments = await Promise.all(
                    segments.map(async (segment) => {
                        if (segment.startsWith("<img")) {
                            return segment;
                        } else if (segment.startsWith("<script")) {
                            return segment;
                        } else {
                            const response = await fetch(
                                `${endpoint}/translate?api-version=${version}&to=${selectedLanguage}`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "Ocp-Apim-Subscription-Key":
                                            subscriptionKey,
                                    },
                                    body: JSON.stringify([{ text: segment }]),
                                }
                            );

                            if (!response.ok) {
                                throw new Error(
                                    "Error en la solicitud de traducción"
                                );
                            }

                            const result = await response.json();
                            return result[0].translations[0].text;
                        }
                    })
                );

                translationPromises.push(translatedSegments.join(""));
            }

            const allTranslations = await Promise.all(translationPromises);

            for (let i = 0; i < elements.length; i++) {
                // Aquí es donde se guarda la traducción en un archivo
                saveTranslationToFile(allTranslations[i], selectedLanguage, i);
            }
        } catch (error) {
            console.error("Error:", error.message);
        }

        closeLanguageSelector();
    }

    function saveTranslationToFile(translation, language, index) {
        // Obtener la ruta original del archivo
        const originalFilePath =
            document.getElementsByClassName("translatedContent")[index].dataset
                .originalFilePath;
        // Crear la ruta para la traducción
        const translationFilePath = originalFilePath.replace(
            "/en/",
            "/" + language + "/"
        );

        // Aquí deberías guardar la traducción en el archivo translationFilePath
        // Por ejemplo, podrías hacer una solicitud al servidor para guardar el contenido traducido
        console.log("Guardando traducción en:", translationFilePath);
    }
</script>
